function show_BubbleNotice(text,delay){
	if(typeof delay === 'undefined'){
		delay=6000;
	}
	$('.t-help-bubble').css('display','none');
	$('body').append("<div class='cornernotice'><div class='cornernotice__close'>&times;</div><div class='cornernotice__text'>"+text+"</div></div>");
	$(".cornernotice").animate({"opacity": "100","right": "20px"}, 400,"easeInCirc", function() {
		setTimeout(function(){
			close_BubbleNotice();
		}, delay);
	});
	$('.cornernotice__close').click(function() {
		close_BubbleNotice();
	});
}
function close_BubbleNotice(){
	$(".cornernotice").animate({"opacity": "0","right": "0px"}, 300,"easeOutCirc", function() {
		$(this).remove();
		$('.t-help-bubble').css('display','block');
	});
}

function showOnboardingPin(pinid,str,left,top,elem,fixed,shiftbubbleleft,shiftbubbletop){

	if( $(window).width()<1200 )return('');

	var firstopen = localStorage.getItem('tp-pin-'+pinid);
	if(firstopen!==null){
		return;
	}

	var data='';
	data += "<div class='onboardingpin' id='"+pinid+"' data-pin-left='"+left+"' data-pin-top='"+top+"' data-pin-fixed='"+fixed+"' data-pin-elem='"+elem+"'>";
	data += "<div class='onboardingpin__wrapper'>";
	data += "<div class='onboardingpin__pin'></div>";
	data += "<div class='onboardingpin__bubble' style='" + (shiftbubbleleft>-2000 ? "left:"+shiftbubbleleft+"px;" : "") + (shiftbubbletop>-2000 ? "top:"+shiftbubbletop+"px;" : "") + "' id='"+pinid+"'>";
	data += "<div class='onboardingpin__msg'>"+str+"</div>";
	data += "<div class='onboardingpin__btn-close'>OK</div>";
	data += "</div>";
	data += "</div>";
	data += "</div>";
	$('body').prepend(data);

	var el=$("#"+pinid);
	updatePinPosition(el);

	el.mouseover(function() {
	  if( $(this).hasClass('onboardingpin_opened')===true )return('');
	  $( this ).addClass('onboardingpin_opened');
	  $(this).find(".onboardingpin__bubble").css('opacity',0);
	  $(this).find(".onboardingpin__bubble").animate({"opacity": "1"}, 500,"easeOutCirc");

	  if ( $( ".onboardingpin__filter" ).length==0 ) {
	  	$('body').prepend("<div class='onboardingpin__filter' style='opacity:0;'></div>");
	  	$(".onboardingpin__filter").animate({"opacity": "0.7"}, 300,"easeOutCirc");

		$( ".onboardingpin__filter" ).click(function() {
			closeOnboardingPinHtml();
		});
	  }
	  localStorage.setItem('tp-pin-'+pinid, Date.now() );
	});

	$( ".onboardingpin__btn-close" ).click(function() {
		closeOnboardingPinHtml();
	});

	setInterval(function() {
	  updatePinPosition(el);
	}, 2000);

}

function updatePinPosition(pin){
	var left=parseInt(pin.attr('data-pin-left'));
	var top=parseInt(pin.attr('data-pin-top'));
	var fixed=pin.attr('data-pin-fixed');

	var elem_left=0;
	var elem_top=0;
	var elem=pin.attr('data-pin-elem');
	if(elem!=''){
		if($(elem).length){
			var offset=$(elem).offset();
			elem_left=parseInt(offset.left);
			if(fixed!='fixed')elem_top=parseInt(offset.top);
		}
	}
	if(fixed=='fixed')pin.css('position','fixed');
	pin.css('left',left+elem_left+'px');
	pin.css('top',top+elem_top+'px');
}

function closeOnboardingPinHtml(el){
	  $('.onboardingpin_opened').remove();
	  $('.onboardingpin__filter').remove();
}

window.showLoadIcon = function (){
	if ($('#loadicon').length == 0) {
		$('body').append('<div id="loadicon" class="spinner"></div>');
	}
	$('#loadicon').css({"display":"block"});
}

window.hideLoadIcon = function (){
	if ($('#loadicon').length > 0) {
		$('#loadicon').css({"display":"none"});
	}
}

function check_logout(data){
	if(typeof data=='string' && data.substring(1,11)=='<!--tlp-->'){
		window.location = '/login/';
		throw new Error("Sorry, you logout!");
	}
}

/* блок подключения приемщиков */
$(document).ready(function(){
	window.simplereloadpage = function (url, sleep) {
		if (sleep && sleep > 0) {
			window.setTimeout(function(){
					if (url && url > '') {
						window.location.href = url;
					} else {
						window.location.reload();
					}
				},
				sleep
			);
		} else {
			if (url && url > '') {
				window.location.href = url;
			} else {
				window.location.reload();
			}
		}
	}

	window.oauthstart = function (url, callback, title) {
		//var url='https://login.mailchimp.com/oauth2/authorize?response_type=code&client_id='+client_id+'&redirect_uri=https%3A%2F%2Ftilda.cc%2Foauth%2Fmailchimp%2F%3Fstate%3D'+user_id;
		var w = $(window).width() > 700 ? 600 : parseInt($(window).width()*0.9);
		var h = $(window).height() > 600 ? 600 :  parseInt($(window).height()*0.9);
		var params = "menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes,width="+w+',height='+h;


		window.showLoadIcon();

		if (!title || title == undefined) {
			title = 'OAuth2 authorization';
		}
		window.oauthstartwin = window.open(url, title, params)

		window.oauthcheck = setInterval(
			function () {
				if(window.oauthstartwin && window.oauthstartwin.document){
					var elem = window.oauthstartwin.document.getElementById('messageid');
					if (elem) {
						window.hideLoadIcon();
						clearInterval(window.oauthcheck);
						window.oauthcheck = false;
						window.oauthstartwin.close();

						if (callback > '') {
							eval(callback+'()');
						}
					}
				}
			},
			200
		);

	}

    var oauthCheckFunctionTry = 0;
    window.oauthCheckFunction = function () {
        try {
            oauthCheckFunctionTry++;
            if (oauthCheckFunctionTry > 5*60*15) {
                closepopup();
                alert ('Reload page and try again.');
                return ;
            }
            //console.log('oauthCheckFunction: '+oauthCheckFunctionTry);
            if (! $('body').hasClass('td-body_popup-opened') || $('#popup_oauth').css('display')=='none') {
                    //console.log('oauthCheckFunction: close popup');

                    window.hideLoadIcon();
                    if (window.oauthcheck) {
                        clearTimeout(window.oauthcheck);
                        window.oauthcheck = false;
                    }
                    return;
            }

            var ifrm = document.getElementById('oauthwindowframe');
            var win = ifrm.contentWindow; // reference to iframe's window
            // reference to document in iframe
            var doc = ifrm.contentDocument? ifrm.contentDocument: ifrm.contentWindow.document;

            if (doc) {
                //console.log('oauthCheckFunction: find doc');
                var elem = doc.getElementById('messageid');
                if (elem) {
                    //console.log('oauthCheckFunction: find message');
                    window.hideLoadIcon();
                    if (window.oauthcheck) {
                        clearTimeout(window.oauthcheck);
                        window.oauthcheck = false;
                    }
                    closepopup();

                    if (callback > '') {
                        eval(callback+'()');
                    }

                }
            } else {
                //console.log('oauthCheckFunction: not found message');

            }
        } catch(e) {
            //console.log('oauthCheckFunction: exception');
            //console.log(e);
        }

        //console.log('oauthCheckFunction: setTimeout');
        window.oauthcheck = setTimeout(oauthCheckFunction, 200);
    }

	window.oauthwindowframe = function (url, callback) {
		//var url='https://login.mailchimp.com/oauth2/authorize?response_type=code&client_id='+client_id+'&redirect_uri=https%3A%2F%2Ftilda.cc%2Foauth%2Fmailchimp%2F%3Fstate%3D'+user_id;
		var w = $(window).width() > 700 ? 600 : parseInt($(window).width()*0.9);
		var h = $(window).height() > 600 ? 600 :  parseInt($(window).height()*0.9);

		if ($('#popup_oauth').length == 0) {
			$('body').append('<div class="td-popup" id="popup_oauth" style="display: none;"><div class="td-popup__wrap"><div class="td-popup-window"><div class="td-popup-window__head"><div class="td-popup-window__close" onclick="closepopup();"></div><div class="td-popup-window__title" style="margin-bottom: 30px;">Connect to service <span id="popup_oauth_service_title"></span></div></div>  <div class="td-popup-window__middle"><div class="td-popup-window__middle-wrapper td-tab-content"><div id="tab_oauth" class="td-tab-pane td-tab-pane_active"></div></div></div> </div></div></div>');
		}
		$('#popup_oauth').data('popup-content','notdelete');
		window.showLoadIcon();
		$('#tab_oauth').html('<iframe src="'+url+'" width="'+w+'" height="'+h+'" frameborder="0" border="0" id="oauthwindowframe" name="oauthwindowframe" scrolling="auto"></iframe>');
		showpopup('#popup_oauth');

        window.oauthcheck = setTimeout(oauthCheckFunction,200);

		return false;
	}

	window.oauthmailchimp = function (url, callback) {
		//var url='https://login.mailchimp.com/oauth2/authorize?response_type=code&client_id='+client_id+'&redirect_uri=https%3A%2F%2Ftilda.cc%2Foauth%2Fmailchimp%2F%3Fstate%3D'+user_id;
		var w = $(window).width() > 700 ? 600 : parseInt($(window).width()*0.9);
		var h = $(window).height() > 600 ? 600 :  parseInt($(window).height()*0.9);
		var params = "menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes,width="+w+',height='+h;

		window.showLoadIcon();

		window.oauthmailchimpwin = window.open(url, "Mailchimp Open ID authorization", params)

		window.oauthcheck = setInterval(
			function () {
				if(window.oauthmailchimpwin && window.oauthmailchimpwin.document){
					var elem = window.oauthmailchimpwin.document.getElementById('messageid');
					if (elem) {
						window.hideLoadIcon();
						clearInterval(window.oauthcheck);
						window.oauthcheck = false;
						window.oauthmailchimpwin.close();


						if (callback > '') {
							eval(callback+'()');
						}
					}
				}
			},
			200
		);
	}

	function mailchimpgetlists() {
		var projectid = $('#allrecords').data('tilda-project-id');
		showLoadIcon();
		$.post('/projects/forms/submit/',{comm:'getlist',recievertype:'mailchimp', projectid: projectid}, function(html){
				hideLoadIcon();

				$('#selectrecieverboxid').hide();
				if (html > '' && html.substring(0,1) == '<') {
					$('#dialogrecieverboxid').show();
					$('#formcontrolrecieverboxid').html(html)
					$('#formnewrecieverboxid').find('input').removeAttr('disabled');
					$form.show();
				} else {
					if (html > '' && html.substring(0,4) == 'http') {
						oauthmailchimp(html,'mailchimpgetlists');
					} else {
						$('#formcontrolrecieverboxid').html('');
						$('#formnewrecieverboxid').find('input').attr('disabled', 'disabled');
					}
				}
			},
			'html'
		);
	}

	function creategsheet() {
		var projectid = $('#allrecords').data('tilda-project-id');
		showLoadIcon();
		$.post('/projects/forms/submit/',{recievertype: 'gsheet', appid: 'new', comm:'recieveredit', projectid: projectid}, function(json){
			hideLoadIcon();
			if(json && json.message > '') {
				var recid = $('#sendformnewrecieverid').data('record-id');
				$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid green;">'+json.message+'</div>');

				if (json.result && json.result.hash) {
					var html = '<label class="pe-label"><input type="checkbox" name="formintegrations'+recid+'[]" value="'+json.result.hash+'" checked="checked"  data-form-type="'+json.result.type+'">Google Sheet: '+json.result.name+'</label>';
					$('#selectrecieverboxid').before(html);


					$('#formnewrecieverboxid').find('input').attr('disabled', 'disabled');
					$('#dialogrecieverboxid').hide();
					$('#selectrecieverboxid').show();

				}


			} else {
				var error = '';
				if(json && json.error) {
					error = json.error;
				} else {
					error = json;
				}

				$('#formnewrecieverlogid').html(error);
			}
		},'json');
	}
	function creategsheetwithauth() {
		var projectid = $('#allrecords').data('tilda-project-id');
		showLoadIcon();
		$.post('/projects/forms/submit/',{comm:'getoauthurl',recievertype:'gsheet', projectid: projectid}, function(html){
				hideLoadIcon();

				$('#selectrecieverboxid').hide();
				if (html > '' && html.substring(0,4) == 'http') {
					window.oauthstart(html,'creategsheet','Google.Sheets connect');
				} else {
					$('#formcontrolrecieverboxid').html('');
					$('#formnewrecieverboxid').find('input').attr('disabled', 'disabled');
				}
			},
			'html'
		);
	}

	$('body').off('change', '#selectrecieverboxid');
	$('body').on('change', '#selectrecieverboxid', function(e){
		var rtype = $(this).val();
		var lang = $(this).data('lang');
		var html = '';
		var $form = $('#dialogrecieverboxid');
		var projectid = $('#allrecords').data('tilda-project-id');
		var redirect_uri;
		$('#formnewrecieverlogid').html('');

		switch (rtype) {
			case 'js-reciever-email':
				html = '<input type="hidden" name="recievertype" value="email" class="js-not-send-on-server">';
				html += '<input type="text" name="appid" class="ss-input js-not-send-on-server" placeholder="'+(lang=='RU' ? 'Email' : 'Email')+'">';
				break;

			case 'js-reciever-mailchimp':
				showLoadIcon();
				mailchimpgetlists();
				return ;
				break;

			case 'js-reciever-gsheet':
				showLoadIcon();
				creategsheetwithauth();
				return ;
				break;

			default:
				if (rtype > '') {
					if (rtype.substring(0,2)=='js') {
						window.location.href='/projects/settings/?projectid='+projectid+'#tab=ss_menu_forms';
					} else {
						window.location.href='/projects/forms/'+rtype+'/?projectid='+projectid;
					}
				}
				break;
		}

		if (html > '') {
			$(this).hide();
			$('#formcontrolrecieverboxid').html(html)
			$('#formnewrecieverboxid').find('input').removeAttr('disabled');
			$form.show();
		} else {
			$('#formcontrolrecieverboxid').html('');
			$('#formnewrecieverboxid').find('input').attr('disabled', 'disabled');
		}
	});


	$('body').off('dblclick', '#sendformnewrecieverid');
	$('body').on('dblclick', '#sendformnewrecieverid', function(e){
		e.preventDefault();
		return false;
	});
	$('body').off('click', '#sendformnewrecieverid');
	$('body').on('click', '#sendformnewrecieverid', function(e){
		e.preventDefault();
		var arPosts = {};
		var lang = $(this).data('lang');
		var recid = $(this).data('record-id');
		$('#formnewrecieverlogid').html('');

		$('#formnewrecieverboxid').find('input,select').each(function(){
			if ($(this).attr('type')!='button' && $(this).attr('type')!='submit') {
				arPosts[ $(this).attr('name') ] = $(this).val();
			}
		});
		$('#formnewrecieverboxid').find('input').attr('disabled', 'disabled');
		$.post('/projects/forms/submit/', arPosts, function(json){
				var error = '';

				if (! json) {
					error = (lang == 'RU' ? '' : '');
				}

				if (json && json.error) {
					error = json.error;
				}

				if (error > '') {
					$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid red;">'+error+'</div>');
					$('#formnewrecieverboxid').find('input').removeAttr('disabled');
				} else {
					if (json.message > '') {
						$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid green;">'+json.message+'</div>');

						if (json.result && json.result.hash) {
							var html = '<label class="pe-label"><input type="checkbox" name="formintegrations'+recid+'[]" value="'+json.result.hash+'" checked="checked"  data-form-type="'+json.result.type+'">'+json.result.name+'</label>';
							$('#selectrecieverboxid').before(html);


							$('#formnewrecieverboxid').find('input').attr('disabled', 'disabled');
							$('#dialogrecieverboxid').hide();
							$('#selectrecieverboxid').show();

						}
					}
				}

			},
			'json'
		).fail(function(data){
			$('#formnewrecieverboxid').find('input').removeAttr('disabled');
			if (data && typeof(data) == 'string') {
				if (data.substring(0,1) == '{') {
					data = $.parseJSON(data);
				} else {
					$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid red;">'+data+'</div>');
				}
			}
			if (data && typeof(data) != 'string') {
				if (data.error) {
					$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid red;">'+data.error+'</div>');
				} else {
					if (data.responseText) {
						$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid red;">'+data.responseText+'</div>');
					} else {
						$('#formnewrecieverlogid').html('<div style="padding: 5px 10px; border: 2px solid red;">Temprary error. Please reload page and try again.</div>');
					}
				}
			}
		});
		return false;
	});

/*
	$('body').off('submit', '#formnewrecieverboxid');
	$('body').on('submit', '#formnewrecieverboxid', function(e){
		e.preventDefault();
		alert('submit');
		return false;
	});
*/
});


	function showHelpBubble(){
		var str='';
		str="<div class='t-help-bubble' style='position:fixed;bottom:30px;right:30px; border-radius:100px;width:60px;height:60px;background-color:rgba(250, 134, 105, 0.9);z-index:3000;box-shadow: 0px 0px 8px 0px rgba(0,0,0,0.2);cursor:pointer;' onclick='showHelpPanel();'><img src='/tpl/img/basic_question_1.svg' style='width:60px;height:60px;'></div>";
		$('body').append(str);
	}

	function showHelpPanel(){
		$('.t-help-bubble').css('display','none');

		var it=[];
		if(lang=='RU'){
			it[0]={'title':'Как устроен интерфейс','link':'http://help-ru.tilda.ws/getstarted'};
			it[1]={'title':'Редактирование страницы','link':'http://help-ru.tilda.ws/#page'};
			it[2]={'title':'Настройки сайта','link':'http://help-ru.tilda.ws/#site'};
			it[3]={'title':'Тарифы и платежи','link':'http://help-ru.tilda.ws/#price'};
			it[4]={'title':'Уроки и статьи','link':'http://help-ru.tilda.ws/#education'};
		}else{
			it[0]={'title':'Get Started','link':'http://help.tilda.ws/getstarted'};
			it[1]={'title':'Page Editing','link':'http://help.tilda.ws/#rec2090036'};
			it[2]={'title':'Site Settings','link':'http://help.tilda.ws/#rec2090043'};
			it[3]={'title':'Price and billings','link':'http://help.tilda.ws/#rec2090051'};
		}

		if(lang=='RU'){
			var q={
				0:{
					title:"Подключение домена",
					link:"http://help-ru.tilda.ws/customdomain"
				},
				1:{
					title:"Прием данных из форм",
					link:"http://help-ru.tilda.ws/forms"
				},
				2:{
					title:"Форма не работает",
					link:"http://help-ru.tilda.ws/forms-errors"
				},
				3:{
					title:"Создание интернет-магазина",
					link:"http://help-ru.tilda.ws/payments"
				},
				4:{
					title:"Действия со страницей",
					link:"http://help-ru.tilda.ws/page-actions"
				},
				5:{
					title:"Создание меню сайта",
					link:"http://help-ru.tilda.ws/menu"
				},
				6:{
					title:"Изменение тарифного плана",
					link:"http://help-ru.tilda.ws/subscription#personaltobusiness"
				},
				7:{
					title:"Вставка своего html-кода",
					link:"http://help-ru.tilda.ws/html"
				},
				8:{
					title:"Добавление своего шрифта",
					link:"http://help-ru.tilda.ws/fonts"
				},
				9:{
					title:"Не видны изменения после публикации",
					link:"http://help-ru.tilda.ws/published"
				},
				10:{
					title:"Как отключить лейбл Made on Tilda",
					link:"http://help-ru.tilda.ws/white-label"
				},
			};
		}else{
			var q={
				0:{
					title:"Assigning own domain",
					link:"http://help.tilda.ws/customdomain"
				},
				1:{
					title:"Set project fonts",
					link:"http://help.tilda.ws/fonts"
				},
				2:{
					title:"Data input fields",
					link:"http://help.tilda.ws/forms"
				},
				3:{
					title:"Creating online store",
					link:"http://help.tilda.ws/payments"
				},
				4:{
					title:"Page Actions",
					link:"http://help.tilda.ws/page-actions"
				},
				5:{
					title:"Creating website menu",
					link:"http://help.tilda.ws/menu"
				},
				6:{
					title:"Upgrade to Business Plan",
					link:"http://help.tilda.ws/subscription#personaltobusiness"
				},
				7:{
					title:"How to insert html code",
					link:"http://help.tilda.ws/html"
				},
				8:{
					title:"There are no changes after publishing",
					link:"http://help.tilda.ws/published"
				},
				9:{
					title:"How to remove label Made on Tilda",
					link:"http://help.tilda.ws/white-label"
				},
			};
		}

		var str='';
		str += '<div class="tc-help">';
		str += '<div class="tc-help__body">';

		str += '<div class="tc-help__header">';
		str += '	<div class="tc-help__header-title-wrapper"><div class="tc-help__header-title">'+ (lang=="RU" ? 'Справочный центр' : 'Help center') +'</div></div>';
		str += '	<div class="tc-help__header-close-wrapper" onclick="closeHelpPanel();"><div class="tc-help__header-close"><img src="/tpl/img/page/tp-08-close.svg" class="tc-help__header-close-ico"></div></div>';
		str += '</div>';

		for(i=0;i<it.length;i++){
		str += '<div class="tc-help__type-body"><a href="'+it[i]['link']+'" target="_blank" class="tc-help__type"><div class="tc-help__type-title-wrapper"><div class="tc-help__type-title">'+it[i]['title']+'</div></div><div class="tc-help__type-icon-wrapper"><div class="tc-help__type-icon-plus"><img src="https://static.tildacdn.com/lib/linea/80173137-4cf3-b0ec-35e3-d593af1a4d0f/basic_link.svg" style="width:15px;"></div><div class="tc-help__type-icon-minus"><img src="/tpl/img/page/tp-14-line.svg" style="opacity:0.3;"></div></div></a></div>';
		}

		str += '<div class="tc-help__items">';
		str += '<div class="tc-help__items-caption">'+ (lang=="RU" ? 'Частые вопросы' : 'F.A.Q.') +'</div>';
		$.each(q, function(index, v) {
		str += '<a href="'+v.link+'" target="_blank" class="tc-help__item">'+v.title+'</a>';
		});
		str += '</div>';

		str += '</div>';

		str += '<div class="tc-help__footer">';
		str += '<div class="tc-help__footer-wrapper">';
		str += '<div class="tc-help__send-btn-hint">'+(lang=="RU" ? "Не нашли ответ на свой вопрос?" : "Didn't find the answer to your question?")+'</div>';
		str += '<a href="/identity/chat/" class="tc-help__send-btn" target="_blank">'+(lang=="RU" ? "Написать нам" : "Send us a message")+'</a>';
		str += '</div>';
		str += '</div>';

		str += '</div>';
		$('body').append(str);
	}

	function closeHelpPanel(){
		$('.tc-help').remove();
		$('.t-help-bubble').css('display','block');
	}

	function str_stripTags(str){
		if (typeof str!='object' && str) {
			str = str.replace(/(<([^>]+)>)/ig,"");
		}
		return str;
	}
	
	function getCSRF(){
		var t=$('#csrf').attr('content');
		if(typeof t!='undefined' && t!=''){
			return t;
		}
	}
